# frozen_string_literal: true

require 'test_helper'
require 'fileutils'

class TestCopyConfig < Minitest::Test
  def setup
    @cc = CopyConfig.new
    @backup_dir = File.join(File.expand_path(__dir__), 'backup_dir')
    @dest_dir = File.join(File.expand_path(__dir__), 'dest_dir')
  end

  def teardown
    FileUtils.rm_rf(@backup_dir)
    FileUtils.rm_rf(@dest_dir)
  end

  def test_creates_backup_dir_and_dest_dir
    refute(Dir.exist?(@backup_dir))
    refute(Dir.exist?(@dest_dir))

    @cc.copy(backup_dir: @backup_dir, dest_dir: @dest_dir, test: true)

    assert(Dir.exist?(@backup_dir))
    assert(Dir.exist?(@dest_dir))
  end

  def test_will_not_error_if_backup_dir_and_dest_dir_exist
    Dir.mkdir(@backup_dir)
    Dir.mkdir(@dest_dir)
    assert(Dir.exist?(@backup_dir))
    assert(Dir.exist?(@dest_dir))

    @cc.copy(backup_dir: @backup_dir, dest_dir: @dest_dir, test: true)

    assert(Dir.exist?(@backup_dir))
    assert(Dir.exist?(@dest_dir))
  end

  def test_backup_dir_empty_and_dest_dir_should_not_be_empty
    @cc.copy(backup_dir: @backup_dir, dest_dir: @dest_dir, test: true)

    # Will not add files to the backup_dir if original dotfiles do not exist
    assert_empty(Dir.children(@backup_dir))

    refute_empty(Dir.children(@dest_dir))
    assert_includes(Dir.children(@dest_dir), '.vimrc')
  end

  def test_backup_dir_not_empty_if_orig_found
    Dir.mkdir(@dest_dir)
    backup_file = File.join(@backup_dir, '.vimrc.orig')

    @cc.copy(backup_dir: @backup_dir, dest_dir: @dest_dir, test: true)

    refute_empty(Dir.children(@backup_dir))
    assert_includes(Dir.children(@backup_dir), '.vimrc.orig')
    assert File.read(f1) == File.read(f2)
  end

  def test_backup_file_will_not_be_overwritten
    Dir.mkdir(@dest_dir)
    Dir.mkdir(@backup_dir)
    f1 = File.join(@dest_dir, '.vimrc')
    f2 = File.join(@backup_dir, '.vimrc.orig')
    File.open(f1, 'w+') { |file| file.puts '1' }
    File.open(f2, 'w+') { |file| file.puts '2' }

    @cc.copy(backup_dir: @backup_dir, dest_dir: @dest_dir, test: true)

    refute File.read(f1) == File.read(f2)
  end
end
